<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Examples • RBF</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Examples">
<meta property="og:description" content="RBF">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">RBF</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Examples.html">Examples</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Examples_files/header-attrs-2.5/header-attrs.js"></script><link href="Examples_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="Examples_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Examples</h1>
                        <h4 class="author">Martínez and Salibian</h4>
            
            <h4 class="date">2021-03-22</h4>
      
      
      <div class="hidden name"><code>Examples.Rmd</code></div>

    </div>

    
    
<div id="about-this-vignette" class="section level1">
<h1 class="hasAnchor">
<a href="#about-this-vignette" class="anchor"></a>About this vignette</h1>
<p>In this vignette we discuss some properties of a robust backfitting estimator for additive models, and illustrate the use of the package <code>RBF</code> that implements it. These estimators were originally proposed in Boente G, Martinez A, Salibian-Barrera M. (2017).</p>
<p>Below we analyze two data sets. The first one shows the robustness of the robust backfitting estimators when a small proportion of very large outliers are present in the training set, and compares them with those obtained with the standard backfitting algorithm. With the second example, we illustrate how these robust estimators can be interpreted as automatically detecting and downweighting potential outliers in the training set. We also compare the prediction accuracy of the robust and classical backfitting algorithms.</p>
<!-- Robust estimators for additive models using backfitting. Journal of Nonparametric Statistics. Taylor & Francis; 29, 744-767. [DOI: 10.1080/10485252.2017.1369077](https://doi.org/10.1080/10485252.2017.1369077) -->
<!-- The `R` package `RBF` (available on CRAN [here](https://cran.r-project.org/package=RBF))  -->
<!-- implements the robust back-fitting algorithm as proposed by -->
<!-- Boente, Martinez and Salibian-Barrera  in  -->
<!-- This repository contains a development version of `RBF` -->
<!-- which may differ slightly from the one available on CRAN -->
<!-- (until the CRAN version is updated appropriately).  -->
<!-- The package in this repository can be installed from within `R` by using the following code (assuming the [devtools](https://cran.r-project.org/package=devtools)) package is available: -->
<!-- ```R -->
<!-- devtools::install_github("msalibian/RBF") -->
<!-- ``` -->
<!-- and charged in the `R` session by the following command -->
<!-- ```{r library} -->
<!-- library("RBF") -->
<!-- ``` -->
<!-- Now that the `R` package is downloaded, we can now start to see how this procedure works. -->
<div id="boston-example" class="section level2">
<h2 class="hasAnchor">
<a href="#boston-example" class="anchor"></a>Boston example</h2>
<p>Consider the well-known <code>Boston</code> house price data of Harrinson and Rubinfeld (1978). This dataset was used as an example to model an additive model by Härdle et a. (2004). The data are available in the <code>MASS</code> package. It contains <span class="math inline">\(n=506\)</span> observations and 14 variables measured on the census districts of the Boston metropolitan area. Following the analysis in Härdle et a. (2004) we use the following 10 explanatory variables:</p>
<ul>
<li>
<code>crim</code>: per capita crime rate by town (<span class="math inline">\(X_1\)</span>),</li>
<li>
<code>indus</code>: proportion of non-retail business acres per town (<span class="math inline">\(X_2\)</span>),</li>
<li>
<code>nox</code>: nitric oxides concentration (parts per 10 million) (<span class="math inline">\(X_3\)</span>),</li>
<li>
<code>rm</code>: average number of rooms per dwelling (<span class="math inline">\(X_4\)</span>),</li>
<li>
<code>age</code>: proportion of owner-occupied units built prior to 1940 (<span class="math inline">\(X_5\)</span>),</li>
<li>
<code>dis</code>: weighted distances to five Boston employment centers (<span class="math inline">\(X_6\)</span>),</li>
<li>
<code>tax</code>: full-value property tax rate per 10,000 (<span class="math inline">\(X_7\)</span>),</li>
<li>
<code>ptratio</code>: pupil-teacher ratio by town (<span class="math inline">\(X_8\)</span>),</li>
<li>
<code>black</code>: <span class="math inline">\(1,000(Bk-0.63)^2\)</span> where <span class="math inline">\(Bk\)</span> is the proportion of people of Afrom American descent by town (<span class="math inline">\(X_9\)</span>),</li>
<li>
<code>lstat</code>: percent lower status of population (<span class="math inline">\(X_{10}\)</span>).</li>
</ul>
<p>The response variable <span class="math inline">\(Y\)</span> is <code>medv</code>, the median value of the owner-occupied homes in 1,000 USD, and the proposed additive model is <span class="math display">\[Y= \mu+ \sum_{j=1}^{10} g_j(\log(X_j))+ \epsilon.\]</span> where <span class="math inline">\(\mu \in \mathbb{R}\)</span>, <span class="math inline">\(g_j\)</span> are unknown smooth functions, and <span class="math inline">\(\epsilon\)</span> are random errors.</p>
<p>First we load the data, and transform the explanatory variables as required by the model above:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">Boston</span>, package<span class="op">=</span><span class="st">'MASS'</span><span class="op">)</span>
<span class="va">dd</span> <span class="op">&lt;-</span> <span class="va">Boston</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">5</span><span class="op">:</span><span class="fl">8</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">14</span><span class="op">)</span><span class="op">]</span>
<span class="va">dd</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">dd</span><span class="op">)</span> <span class="op">!=</span> <span class="st">'medv'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span> <span class="va">dd</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">dd</span><span class="op">)</span> <span class="op">!=</span> <span class="st">'medv'</span><span class="op">]</span> <span class="op">)</span></code></pre></div>
<p>Next, we load the <code>RBF</code> package</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">RBF</span><span class="op">)</span></code></pre></div>
<p>The robust backfitting estimators for each additive component are computed using robust kernel-based local polynomial regression. The model to be fit is specified using the standard <code>formula</code> notation in <code>R</code>. We also need to specify the following arguments:</p>
<ul>
<li>
<code>windows</code>: the bandwidths for the kernel estimators,</li>
<li>
<code>degree</code>: the degree of the polynomial used for the kernel local regression, defaults to <code>0</code>,</li>
<li>
<code>type</code>: specifies the robust loss function, options are <code>Huber</code> or <code>Tukey</code>, defaults to <code>Huber</code>.</li>
</ul>
<p>As with all kernel-based estimators, bandwidth selection is an important step. In this example we follow Härdle et al. (2004) and select bandwidths <span class="math inline">\(h_j\)</span>, <span class="math inline">\(1 \le j \le 10\)</span>, proportional to the standard deviation of the corresponding explanatory variables <span class="math inline">\(\log(X_j)\)</span>. Specifically we set <span class="math inline">\(h_j = \hat{\sigma}_j / 2\)</span>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bandw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">dd</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">dd</span><span class="op">)</span> <span class="op">!=</span> <span class="st">'medv'</span><span class="op">]</span>, <span class="fl">2</span>, <span class="va">sd</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span></code></pre></div>
<p>We are now ready to compute the robust backfitting estimators:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">robust.fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/backf.rob.html">backf.rob</a></span><span class="op">(</span><span class="va">medv</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">dd</span>, degree <span class="op">=</span> <span class="fl">0</span>, type <span class="op">=</span> <span class="st">'Huber'</span>, 
                        windows <span class="op">=</span> <span class="va">bandw</span><span class="op">)</span></code></pre></div>
<p>Information about the fit can be obtained using the <code>summary</code> method:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">robust.fit</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; backf.rob(formula = medv ~ ., data = dd, windows = bandw, degree = 0, </span>
<span class="co">#&gt;     type = "Huber")</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Estimate of the intercept:  22.20546 </span>
<span class="co">#&gt; Estimate of the residual standard error:  0.22239 </span>
<span class="co">#&gt; Robust multiple R-squared:  0.69872 </span>
<span class="co">#&gt; Residuals:</span>
<span class="co">#&gt;  Min. 1st Qu. Median Mean 3rd Qu. Max. </span>
<span class="co">#&gt;  -18.41161 -1.251476 0.002993124 0.3273419 1.457033 31.67697</span></code></pre></div>
<p>Note that the summary output includes a robust version of the R-squared coefficient, which is computed as <span class="math display">\[
R^2_{rob}=\frac{\sum_{i=1}^n \rho\left((Y_i-\widehat{a})/\widehat{\sigma}\right)-\sum_{i=1}^n \rho\left(R_i/\widehat{\sigma}\right)}{\sum_{i=1}^n \rho\left((Y_i-\widehat{a})/\widehat{\sigma}\right)} \, ,
\]</span> where <span class="math inline">\(\rho\)</span> is the loss function used by the M-kernel smoothers (as determined by the argument <code>type</code> in the call to <code>backf.rob</code>), and <span class="math inline">\(\widehat{a}\)</span> is a robust location estimator for a model without explanatory variables: <span class="math inline">\(Y=a+\epsilon\)</span>. <!-- are present. $R_i=Y_i-\widehat{\mu}-\sum_{j=1}^p \widehat{g}_j(X_{ij})$ and $\rho$ is the loss function in the `type` argument. --></p>
<p>The plot method can be used to visualize the estimated additive components <span class="math inline">\(\hat{g}_j\)</span>, displayed over the corresponding partial residuals: <span class="math display">\[
R_{ij}=Y_i-\hat{\mu}-\sum_{k\neq i}\hat{g}_k(X_{ik}) \, , 
\quad 1 \le i \le 506\, , \quad 1 \le j \le 10 \, . 
\]</span></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">robust.fit</span><span class="op">)</span></code></pre></div>
<p><img src="Examples_files/figure-html/plot-1.png" width="45%"><img src="Examples_files/figure-html/plot-2.png" width="45%"><img src="Examples_files/figure-html/plot-3.png" width="45%"><img src="Examples_files/figure-html/plot-4.png" width="45%"><img src="Examples_files/figure-html/plot-5.png" width="45%"><img src="Examples_files/figure-html/plot-6.png" width="45%"><img src="Examples_files/figure-html/plot-7.png" width="45%"><img src="Examples_files/figure-html/plot-8.png" width="45%"><img src="Examples_files/figure-html/plot-9.png" width="45%"><img src="Examples_files/figure-html/plot-10.png" width="45%"></p>
<p>By default, <code>backf.rob</code> computes fitted values on the training set. If predictions at a different specific point are desired, we can pass those points using the argumen <code>point</code>. For example, to obtain predicted values at a point <code>po</code> given by the average of the (log transformed) explanatory variables, we can use the following command (note that this step implies re-fitting the whole model):</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">po</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">dd</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">dd</span><span class="op">)</span> <span class="op">!=</span> <span class="st">'medv'</span><span class="op">]</span><span class="op">)</span>
<span class="va">robust.fit1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/backf.rob.html">backf.rob</a></span><span class="op">(</span><span class="va">medv</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">dd</span>, degree <span class="op">=</span> <span class="fl">0</span>, type <span class="op">=</span> <span class="st">'Huber'</span>, 
                         windows <span class="op">=</span> <span class="va">bandw</span>, point <span class="op">=</span> <span class="va">po</span><span class="op">)</span></code></pre></div>
<p>The values of the estimated components evaluated at the corresponding coordinates of <code>po</code> are returned in the <code>$prediction</code> element:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">robust.fit1</span><span class="op">$</span><span class="va">prediction</span>
<span class="co">#&gt;           crim      indus       nox        rm      age      dis        tax</span>
<span class="co">#&gt; [1,] 0.4502372 -0.2941408 0.5036051 -1.549345 0.484823 1.266611 -0.5900875</span>
<span class="co">#&gt;         ptratio     black      lstat</span>
<span class="co">#&gt; [1,] -0.2291248 0.1912795 -0.1634099</span></code></pre></div>
<p>In order to illustrate the behaviour of the robust fit when outliers are present in the data, we artifically introduce 1% of atypical values in the response variable:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dd2</span> <span class="op">&lt;-</span> <span class="va">dd</span>
<span class="va">dd2</span><span class="op">$</span><span class="va">medv</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">400</span>, <span class="fl">5</span><span class="op">)</span></code></pre></div>
<p>We now calculate the robust estimators using the contaminated data set. Note that we expect them to be very similar to those we obtained before with the original training set.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">robust.fit.new</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/backf.rob.html">backf.rob</a></span><span class="op">(</span><span class="va">medv</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">dd2</span>, degree <span class="op">=</span> <span class="fl">0</span>, type <span class="op">=</span> <span class="st">'Huber'</span>, 
                            windows <span class="op">=</span> <span class="va">bandw</span>, point <span class="op">=</span> <span class="va">po</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">robust.fit.new</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; backf.rob(formula = medv ~ ., data = dd2, windows = bandw, point = po, </span>
<span class="co">#&gt;     degree = 0, type = "Huber")</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Estimate of the intercept:  22.21968 </span>
<span class="co">#&gt; Estimate of the residual standard error:  0.22239 </span>
<span class="co">#&gt; Robust multiple R-squared:  0.44603 </span>
<span class="co">#&gt; Residuals:</span>
<span class="co">#&gt;  Min. 1st Qu. Median Mean 3rd Qu. Max. </span>
<span class="co">#&gt;  -18.35562 -1.249837 0.002044039 3.969449 1.489455 378.8072</span>
<span class="va">robust.fit.new</span><span class="op">$</span><span class="va">prediction</span>
<span class="co">#&gt;           crim      indus       nox        rm       age      dis        tax</span>
<span class="co">#&gt; [1,] 0.3669282 -0.3464365 0.5552477 -1.573039 0.5296952 1.248268 -0.5550474</span>
<span class="co">#&gt;         ptratio     black      lstat</span>
<span class="co">#&gt; [1,] -0.2196106 0.1936705 -0.1590413</span></code></pre></div>
<p>From the output above we verify that the predictions at the point <code>po</code> with both fits are very similar to each other.<br>
Because the magnitude of the outliers affects the scale of the partial residuals plots, to compare both fits below we plot the robust estimators for each additive component trained on the original and contaminated data sets (without including the partial residuals). In green and dashed lines the robust estimator computed with the original data set, and in blue and solid lines the robust estimator computed with the contaminated data set. We see that, indeed, both sets of estimated additive components are very similar to each other.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">name.x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">dd</span><span class="op">)</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> 
  <span class="va">name.y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/bquote.html">bquote</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grDevices/plotmath.html">hat</a></span><span class="op">(</span><span class="st">'g'</span><span class="op">)</span><span class="op">[</span><span class="fu">.</span><span class="op">(</span><span class="va">j</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
  <span class="va">oo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">dd2</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">dd2</span><span class="op">[</span><span class="va">oo</span>,<span class="va">j</span><span class="op">]</span>, <span class="va">robust.fit.new</span><span class="op">$</span><span class="va">g.matrix</span><span class="op">[</span><span class="va">oo</span>,<span class="va">j</span><span class="op">]</span>, type<span class="op">=</span><span class="st">"l"</span>, lwd<span class="op">=</span><span class="fl">2</span>, col<span class="op">=</span><span class="st">'blue'</span>, lty<span class="op">=</span><span class="fl">1</span>, 
       xlab<span class="op">=</span><span class="va">name.x</span>, ylab<span class="op">=</span><span class="va">name.y</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">dd2</span><span class="op">[</span><span class="va">oo</span>,<span class="va">j</span><span class="op">]</span>, <span class="va">robust.fit</span><span class="op">$</span><span class="va">g.matrix</span><span class="op">[</span><span class="va">oo</span>,<span class="va">j</span><span class="op">]</span>, lwd<span class="op">=</span><span class="fl">2</span>, col<span class="op">=</span><span class="st">'green'</span>, lty<span class="op">=</span><span class="fl">2</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p><img src="Examples_files/figure-html/robustplots2-1.png" width="45%"><img src="Examples_files/figure-html/robustplots2-2.png" width="45%"><img src="Examples_files/figure-html/robustplots2-3.png" width="45%"><img src="Examples_files/figure-html/robustplots2-4.png" width="45%"><img src="Examples_files/figure-html/robustplots2-5.png" width="45%"><img src="Examples_files/figure-html/robustplots2-6.png" width="45%"><img src="Examples_files/figure-html/robustplots2-7.png" width="45%"><img src="Examples_files/figure-html/robustplots2-8.png" width="45%"><img src="Examples_files/figure-html/robustplots2-9.png" width="45%"><img src="Examples_files/figure-html/robustplots2-10.png" width="45%"></p>
<p>It is easy to see that when we use the classical backfitting estimator the fits obtained when the training set contains outliers are dramatically different from the ones obtained with the original data set. We use the package <code>gam</code> to compute the standard backfitting algorithm (based on local kernel regression smoothers). The bandwidths used to compute the classical estimates are again proportional to the standard deviations of the explanatory variables, but we use a slightly larger coefficient to avoid numerical issues with the local fits. We set <span class="math inline">\(h_j=(3/4) \, \widehat{\sigma}_j\)</span>, for <span class="math inline">\(1 \le j \le 10\)</span>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">gam</span><span class="op">)</span>
<span class="co">#&gt; Loading required package: splines</span>
<span class="co">#&gt; Loading required package: foreach</span>
<span class="co">#&gt; Loaded gam 1.20</span>
<span class="va">fit.gam</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/gam.html">gam</a></span><span class="op">(</span><span class="va">medv</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">crim</span>, span<span class="op">=</span><span class="fl">1.62</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">indus</span>, span<span class="op">=</span><span class="fl">0.58</span><span class="op">)</span> <span class="op">+</span> 
                 <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">nox</span>, span<span class="op">=</span><span class="fl">0.15</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">rm</span>, span<span class="op">=</span><span class="fl">0.08</span><span class="op">)</span> <span class="op">+</span>
                 <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">age</span>, span<span class="op">=</span><span class="fl">0.46</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">dis</span>, span<span class="op">=</span><span class="fl">0.40</span><span class="op">)</span> <span class="op">+</span> 
                 <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">tax</span>, span<span class="op">=</span><span class="fl">0.30</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">ptratio</span>, span<span class="op">=</span><span class="fl">0.09</span><span class="op">)</span> <span class="op">+</span>
                 <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">black</span>, span<span class="op">=</span><span class="fl">0.58</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">lstat</span>, span<span class="op">=</span><span class="fl">0.45</span><span class="op">)</span>, data<span class="op">=</span><span class="va">dd</span><span class="op">)</span>
<span class="va">fits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit.gam</span>, type<span class="op">=</span><span class="st">'terms'</span><span class="op">)</span>
<span class="va">fit.gam.new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/gam.html">gam</a></span><span class="op">(</span><span class="va">medv</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">crim</span>, span<span class="op">=</span><span class="fl">1.62</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">indus</span>, span<span class="op">=</span><span class="fl">0.58</span><span class="op">)</span> <span class="op">+</span> 
                 <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">nox</span>, span<span class="op">=</span><span class="fl">0.15</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">rm</span>, span<span class="op">=</span><span class="fl">0.08</span><span class="op">)</span> <span class="op">+</span>
                 <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">age</span>, span<span class="op">=</span><span class="fl">0.46</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">dis</span>, span<span class="op">=</span><span class="fl">0.40</span><span class="op">)</span> <span class="op">+</span> 
                 <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">tax</span>, span<span class="op">=</span><span class="fl">0.30</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">ptratio</span>, span<span class="op">=</span><span class="fl">0.09</span><span class="op">)</span> <span class="op">+</span>
                 <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">black</span>, span<span class="op">=</span><span class="fl">0.58</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">lstat</span>, span<span class="op">=</span><span class="fl">0.45</span><span class="op">)</span>, data<span class="op">=</span><span class="va">dd2</span><span class="op">)</span>
<span class="va">fits.new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit.gam.new</span>, type<span class="op">=</span><span class="st">'terms'</span><span class="op">)</span></code></pre></div>
<p>In the plots below, the standard backfitting estimates calculated with the original <code>Boston</code> data set are shown with orange and dashed lines, while those obtained with the contaminated training set are shown with purple and solid lines.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">oo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">dd2</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span><span class="op">)</span>
  <span class="va">name.x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">dd</span><span class="op">)</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> 
  <span class="va">name.y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/bquote.html">bquote</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grDevices/plotmath.html">hat</a></span><span class="op">(</span><span class="st">'g'</span><span class="op">)</span><span class="op">[</span><span class="fu">.</span><span class="op">(</span><span class="va">j</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">dd2</span><span class="op">[</span><span class="va">oo</span>,<span class="va">j</span><span class="op">]</span>, <span class="va">fits.new</span><span class="op">[</span><span class="va">oo</span>,<span class="va">j</span><span class="op">]</span>, type<span class="op">=</span><span class="st">"l"</span>, lwd<span class="op">=</span><span class="fl">2</span>, col<span class="op">=</span><span class="st">'purple'</span>, lty<span class="op">=</span><span class="fl">1</span>, 
       xlab<span class="op">=</span><span class="va">name.x</span>, ylab<span class="op">=</span><span class="va">name.y</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">dd2</span><span class="op">[</span><span class="va">oo</span>,<span class="va">j</span><span class="op">]</span>, <span class="va">fits</span><span class="op">[</span><span class="va">oo</span>,<span class="va">j</span><span class="op">]</span>, lwd<span class="op">=</span><span class="fl">2</span>, col<span class="op">=</span><span class="st">'darkorange2'</span>, lty<span class="op">=</span><span class="fl">2</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p><img src="Examples_files/figure-html/gamplots-1.png" width="45%"><img src="Examples_files/figure-html/gamplots-2.png" width="45%"><img src="Examples_files/figure-html/gamplots-3.png" width="45%"><img src="Examples_files/figure-html/gamplots-4.png" width="45%"><img src="Examples_files/figure-html/gamplots-5.png" width="45%"><img src="Examples_files/figure-html/gamplots-6.png" width="45%"><img src="Examples_files/figure-html/gamplots-7.png" width="45%"><img src="Examples_files/figure-html/gamplots-8.png" width="45%"><img src="Examples_files/figure-html/gamplots-9.png" width="45%"><img src="Examples_files/figure-html/gamplots-10.png" width="45%"></p>
</div>
<div id="airquality-example" class="section level2">
<h2 class="hasAnchor">
<a href="#airquality-example" class="anchor"></a>Airquality example</h2>
<p>The <code>airquality</code> data set contains 153 daily air quality measurements in the New York region between May and September, 1973 (Chambers et al., 1983). The interest is in modeling the mean Ozone (<span class="math inline">\(\mbox{O}_3\)</span>) concentration as a function of 3 potential explanatory variables: solar radiance in the frequency band 4000-7700 (Solar.R), wind speed (Wind) and temperature (Temp). We focus on the 111 complete entries in the data set.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>
<span class="va">ccs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">airquality</span><span class="op">)</span>
<span class="va">aircomplete</span> <span class="op">&lt;-</span> <span class="va">airquality</span><span class="op">[</span><span class="va">ccs</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Ozone'</span>, <span class="st">'Solar.R'</span>, <span class="st">'Wind'</span>, <span class="st">'Temp'</span><span class="op">)</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html">pairs</a></span><span class="op">(</span><span class="va">aircomplete</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Ozone'</span>, <span class="st">'Solar.R'</span>, <span class="st">'Wind'</span>, <span class="st">'Temp'</span><span class="op">)</span><span class="op">]</span>, pch<span class="op">=</span><span class="fl">19</span>, col<span class="op">=</span><span class="st">'gray30'</span><span class="op">)</span></code></pre></div>
<p><img src="Examples_files/figure-html/scatterplot-1.png" width="75%"></p>
<p>The scatter plot suggests that the relationship between ozone and the other variables in not linear and so we propose using an additive regression model of the form <span class="math display">\[\begin{equation} \label{eq:ozone-model}
\mbox{Ozone}=\mu+g_{1}(\mbox{Solar.R})+g_{2}(\mbox{Wind})+g_{3}(\mbox{Temp}) + \varepsilon \, .
\end{equation}\]</span> To fit this model above we use robust local linear kernel M-estimators and Tukey’s bisquare loss function. These choices are set using the arguments <code>degree = 1</code> and <code>type='Tukey'</code> in the call to the function <code>backf.rob</code>. The model is specified with the standard formula notation in R. The argument <code>windows</code> is a vector with the bandwidths to be used with each kernel smoother. To estimate optimal values we used a robust leave-one-out cross-validation approach (see Boente et al., 2017). As a robust prediction error measure we use <code>mu^2 + sigma^2</code> where <code>mu</code> and <code>sigma</code> are M-estimators of location and scale of the prediction errors, respectively.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">RBF</span><span class="op">)</span>

<span class="co"># Bandwidth selection with leave-one-out cross-validation</span>
<span class="co">## Without outliers</span>
<span class="co"># This takes a long time to compute (approx 380 minutes running</span>
<span class="co"># R 3.6.1 on an Intel(R) Core(TM) i7-4790 CPU @ 3.60GHz)</span>
<span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">1.5</span>, <span class="fl">2</span>, <span class="fl">2.5</span>, <span class="fl">3</span><span class="op">)</span>
<span class="va">h1</span> <span class="op">&lt;-</span> <span class="va">a</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">aircomplete</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>
<span class="va">h2</span> <span class="op">&lt;-</span> <span class="va">a</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">aircomplete</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span>
<span class="va">h3</span> <span class="op">&lt;-</span> <span class="va">a</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">aircomplete</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span><span class="op">)</span>
<span class="va">hh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span><span class="va">h1</span>, <span class="va">h2</span>, <span class="va">h3</span><span class="op">)</span>
<span class="va">nh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">hh</span><span class="op">)</span>
<span class="va">rmspe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">nh</span><span class="op">)</span>
<span class="va">jbest</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="va">cvbest</span> <span class="op">&lt;-</span> <span class="op">+</span><span class="cn">Inf</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">aircomplete</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nh</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># leave-one-out CV loop</span>
  <span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">n</span><span class="op">)</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span> <span class="fu"><a href="../reference/backf.rob.html">backf.rob</a></span><span class="op">(</span><span class="va">Ozone</span> <span class="op">~</span> <span class="va">Solar.R</span> <span class="op">+</span> <span class="va">Wind</span> <span class="op">+</span> <span class="va">Temp</span>, point <span class="op">=</span> <span class="va">aircomplete</span><span class="op">[</span><span class="va">j</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span>,
                          windows <span class="op">=</span> <span class="va">hh</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span>, epsilon <span class="op">=</span> <span class="fl">1e-6</span>, data <span class="op">=</span> <span class="va">aircomplete</span>,
                          degree <span class="op">=</span> <span class="fl">1</span>, type <span class="op">=</span> <span class="st">'Tukey'</span>, subset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">j</span><span class="op">)</span> <span class="op">)</span><span class="op">)</span>
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">!=</span> <span class="st">"try-error"</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">preds</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">$</span><span class="va">prediction</span><span class="op">)</span> <span class="op">+</span> <span class="va">tmp</span><span class="op">$</span><span class="va">alpha</span>
    <span class="op">}</span>
  <span class="op">}</span>
  <span class="va">tmp.re</span> <span class="op">&lt;-</span> <span class="fu">RobStatTM</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RobStatTM/man/MLocDis.html">locScaleM</a></span><span class="op">(</span><span class="va">preds</span> <span class="op">-</span> <span class="va">aircomplete</span><span class="op">$</span><span class="va">Ozone</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
  <span class="va">rmspe</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">tmp.re</span><span class="op">$</span><span class="va">mu</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="va">tmp.re</span><span class="op">$</span><span class="va">disper</span><span class="op">^</span><span class="fl">2</span>
  <span class="kw">if</span><span class="op">(</span> <span class="va">rmspe</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;</span> <span class="va">cvbest</span> <span class="op">)</span> <span class="op">{</span>
    <span class="va">jbest</span> <span class="op">&lt;-</span> <span class="va">i</span>
    <span class="va">cvbest</span> <span class="op">&lt;-</span> <span class="va">rmspe</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>
  <span class="op">}</span>
<span class="op">}</span>
<span class="op">(</span><span class="va">bandw</span> <span class="op">&lt;-</span> <span class="va">hh</span><span class="op">[</span><span class="va">jbest</span>,<span class="op">]</span><span class="op">)</span></code></pre></div>
<p>The resulting bandwidths are:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">bandw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">136.7285</span>, <span class="fl">10.67314</span>, <span class="fl">4.764985</span><span class="op">)</span></code></pre></div>
<p>Now we use the robust backfitting algorithm to fit an additive model using Tukey’s bisquare loss (the default tuning constant for this loss function is 4.685) and the optimal bandwidths.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit.full</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/backf.rob.html">backf.rob</a></span><span class="op">(</span><span class="va">Ozone</span> <span class="op">~</span> <span class="va">Solar.R</span> <span class="op">+</span> <span class="va">Wind</span> <span class="op">+</span> <span class="va">Temp</span>, windows <span class="op">=</span> <span class="va">bandw</span>, 
                      epsilon <span class="op">=</span> <span class="fl">1e-6</span>, degree <span class="op">=</span> <span class="fl">1</span>, type <span class="op">=</span> <span class="st">'Tukey'</span>, 
                      subset <span class="op">=</span> <span class="va">ccs</span>, data <span class="op">=</span> <span class="va">airquality</span><span class="op">)</span></code></pre></div>
<p>We can visually explore the estimated additive functions plotted over the corresponding partial residuals using the method <code>plot</code>:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">fit.full</span><span class="op">)</span></code></pre></div>
<p><img src="Examples_files/figure-html/plotfitfull-1.png" width="45%"><img src="Examples_files/figure-html/plotfitfull-2.png" width="45%"><img src="Examples_files/figure-html/plotfitfull-3.png" width="45%"></p>
<p>As before, we use the R package <code>gam</code> to compute the classical additive model estimators for this model. Optimal bandwidths were calculated using leave-one-out cross-validation as before:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">gam</span><span class="op">)</span>
<span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.3</span>, <span class="fl">.4</span>, <span class="fl">.5</span>, <span class="fl">.6</span>, <span class="fl">.7</span>, <span class="fl">.8</span>, <span class="fl">.9</span><span class="op">)</span>
<span class="va">hh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span><span class="va">a</span>, <span class="va">a</span>, <span class="va">a</span><span class="op">)</span>
<span class="va">nh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">hh</span><span class="op">)</span>
<span class="va">jbest</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="va">cvbest</span> <span class="op">&lt;-</span> <span class="op">+</span><span class="cn">Inf</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">aircomplete</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nh</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">fi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span><span class="op">)</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/gam.html">gam</a></span><span class="op">(</span><span class="va">Ozone</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">Solar.R</span>, span<span class="op">=</span><span class="va">hh</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">Wind</span>, span<span class="op">=</span><span class="va">hh</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>
               <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">Temp</span>, span<span class="op">=</span><span class="va">hh</span><span class="op">[</span><span class="va">i</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">aircomplete</span>, subset<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">j</span><span class="op">)</span><span class="op">)</span>
    <span class="va">fi</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">tmp</span>, newdata<span class="op">=</span><span class="va">aircomplete</span><span class="op">[</span><span class="va">j</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span>, type<span class="op">=</span><span class="st">'response'</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="va">ss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">aircomplete</span><span class="op">$</span><span class="va">Ozone</span> <span class="op">-</span> <span class="va">fi</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>
  <span class="kw">if</span><span class="op">(</span><span class="va">ss</span> <span class="op">&lt;</span> <span class="va">cvbest</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">jbest</span> <span class="op">&lt;-</span> <span class="va">i</span>
    <span class="va">cvbest</span> <span class="op">&lt;-</span> <span class="va">ss</span>
  <span class="op">}</span>
<span class="op">}</span>
<span class="op">(</span><span class="va">hh</span><span class="op">[</span><span class="va">jbest</span>,<span class="op">]</span><span class="op">)</span>
<span class="co"># Var1 Var2 Var3</span>
<span class="co"># 0.7  0.7  0.5</span></code></pre></div>
<p>The optimal bandwidths are <code>0.7</code>, <code>0.7</code> and <code>0.5</code> for <code>Solar.R</code>, <code>Wind</code> and <code>Temp</code>, respectively, and we use them to compute the backfitting estimators:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit.gam</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/gam.html">gam</a></span><span class="op">(</span><span class="va">Ozone</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">Solar.R</span>, span<span class="op">=</span><span class="fl">.7</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">Wind</span>, span<span class="op">=</span><span class="fl">.7</span><span class="op">)</span><span class="op">+</span>
                 <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">Temp</span>, span<span class="op">=</span><span class="fl">.5</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">aircomplete</span><span class="op">)</span></code></pre></div>
<p>Both classical (in magenta and dashed lines) and robust (in blue and solid lines) fits are shown in the following plot together with the partial residuals obtained by the robust fit.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span> <span class="va">aircomplete</span><span class="op">[</span> , <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Solar.R'</span>, <span class="st">'Wind'</span>, <span class="st">'Temp'</span><span class="op">)</span><span class="op">]</span> <span class="op">)</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span> <span class="va">aircomplete</span><span class="op">[</span> , <span class="st">'Ozone'</span><span class="op">]</span> <span class="op">)</span>
<span class="va">fits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit.gam</span>, type<span class="op">=</span><span class="st">'terms'</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">re</span> <span class="op">&lt;-</span> <span class="va">fit.full</span><span class="op">$</span><span class="va">yp</span> <span class="op">-</span> <span class="va">fit.full</span><span class="op">$</span><span class="va">alpha</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">fit.full</span><span class="op">$</span><span class="va">g.matrix</span><span class="op">[</span>,<span class="op">-</span><span class="va">j</span><span class="op">]</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">re</span> <span class="op">~</span> <span class="va">x</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span>, type<span class="op">=</span><span class="st">'p'</span>, pch<span class="op">=</span><span class="fl">20</span>, col<span class="op">=</span><span class="st">'gray45'</span>, xlab<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>, ylab<span class="op">=</span><span class="st">''</span><span class="op">)</span>
  <span class="va">oo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">oo</span>,<span class="va">j</span><span class="op">]</span>, <span class="va">fit.full</span><span class="op">$</span><span class="va">g.matrix</span><span class="op">[</span><span class="va">oo</span>,<span class="va">j</span><span class="op">]</span>, lwd<span class="op">=</span><span class="fl">2</span>, col<span class="op">=</span><span class="st">'blue'</span>, lty<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">oo</span>,<span class="va">j</span><span class="op">]</span>, <span class="va">fits</span><span class="op">[</span><span class="va">oo</span>,<span class="va">j</span><span class="op">]</span>, lwd<span class="op">=</span><span class="fl">2</span>, col<span class="op">=</span><span class="st">'magenta'</span>, lty<span class="op">=</span><span class="fl">2</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p><img src="Examples_files/figure-html/plotrobgam-1.png" width="45%"><img src="Examples_files/figure-html/plotrobgam-2.png" width="45%"><img src="Examples_files/figure-html/plotrobgam-3.png" width="45%"></p>
<p>The two fits differ mainly on the estimated effects of wind speed and temperature. The classical estimate for <span class="math inline">\(g_1(\mbox{Temp})\)</span> is consistently lower than the robust counterpart for <span class="math inline">\(\mbox{Temp} \ge 85\)</span>. For wind speed, the non-robust estimate <span class="math inline">\(\hat{g}_2(\mbox{Wind})\)</span> suggests a higher effect over Ozone concentrations for low wind speeds than the one given by the robust estimate, and the opposite difference for higher speeds.</p>
<p>Since residuals from a robust fit can generally be used to detect the presence of atypical observations in the training data, we plot the boxplot of the residuals obtained by the robust fit and 4 possible outlying points (indicated with red circles) can be observed.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">re.ro</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">fit.full</span><span class="op">)</span>
<span class="va">ou.ro</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html">boxplot</a></span><span class="op">(</span><span class="va">re.ro</span>, col<span class="op">=</span><span class="st">'gray80'</span><span class="op">)</span><span class="op">$</span><span class="va">out</span>
<span class="va">in.ro</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">re.ro</span><span class="op">)</span><span class="op">)</span><span class="op">[</span> <span class="va">re.ro</span> <span class="op">%in%</span> <span class="va">ou.ro</span> <span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">in.ro</span><span class="op">)</span><span class="op">)</span>, <span class="va">re.ro</span><span class="op">[</span><span class="va">in.ro</span><span class="op">]</span>, pch<span class="op">=</span><span class="fl">20</span>, col<span class="op">=</span><span class="st">'red'</span><span class="op">)</span></code></pre></div>
<p><img src="Examples_files/figure-html/boxplot-1.png" width="50%"></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span><span class="va">in.ro</span><span class="op">)</span>
<span class="co">#&gt; [1] 23 34 53 77</span></code></pre></div>
<p>We highlight these suspicious observations on the scatter plot.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">'gray30'</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">aircomplete</span><span class="op">)</span><span class="op">)</span>
<span class="va">cs</span><span class="op">[</span><span class="va">in.ro</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'red'</span>
<span class="va">os</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">aircomplete</span><span class="op">)</span>
<span class="va">os2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">os</span><span class="op">[</span><span class="op">-</span><span class="va">in.ro</span><span class="op">]</span>, <span class="va">os</span><span class="op">[</span><span class="va">in.ro</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html">pairs</a></span><span class="op">(</span><span class="va">aircomplete</span><span class="op">[</span><span class="va">os2</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Ozone'</span>, <span class="st">'Solar.R'</span>, <span class="st">'Wind'</span>, <span class="st">'Temp'</span><span class="op">)</span><span class="op">]</span>, 
      pch<span class="op">=</span><span class="fl">19</span>, col<span class="op">=</span><span class="va">cs</span><span class="op">[</span><span class="va">os2</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<p><img src="Examples_files/figure-html/scatterplotpoints-1.png" width="75%"></p>
<p>Note that not all these suspected atypical observations are particularly extreme, or directly evident on the scatter plot. However, as we will show below, they do have an important effect on the estimates of the components of the additive model.</p>
<p>The partial residuals corresponding to these points can be also visualized in red in the plot of the estimated curves.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Plot both fits (robust and classical) </span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span> <span class="va">aircomplete</span><span class="op">[</span> , <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Solar.R'</span>, <span class="st">'Wind'</span>, <span class="st">'Temp'</span><span class="op">)</span><span class="op">]</span> <span class="op">)</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span> <span class="va">aircomplete</span><span class="op">[</span> , <span class="st">'Ozone'</span><span class="op">]</span> <span class="op">)</span>
<span class="va">fits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit.gam</span>, type<span class="op">=</span><span class="st">'terms'</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">re</span> <span class="op">&lt;-</span> <span class="va">fit.full</span><span class="op">$</span><span class="va">yp</span> <span class="op">-</span> <span class="va">fit.full</span><span class="op">$</span><span class="va">alpha</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">fit.full</span><span class="op">$</span><span class="va">g.matrix</span><span class="op">[</span>,<span class="op">-</span><span class="va">j</span><span class="op">]</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">re</span> <span class="op">~</span> <span class="va">x</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span>, type<span class="op">=</span><span class="st">'p'</span>, pch<span class="op">=</span><span class="fl">20</span>, col<span class="op">=</span><span class="st">'gray45'</span>, xlab<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>, ylab<span class="op">=</span><span class="st">''</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">re</span><span class="op">[</span><span class="va">in.ro</span><span class="op">]</span> <span class="op">~</span> <span class="va">x</span><span class="op">[</span><span class="va">in.ro</span>,<span class="va">j</span><span class="op">]</span>, pch<span class="op">=</span><span class="fl">20</span>, col<span class="op">=</span><span class="st">'red'</span><span class="op">)</span>
  <span class="va">oo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">oo</span>,<span class="va">j</span><span class="op">]</span>, <span class="va">fit.full</span><span class="op">$</span><span class="va">g.matrix</span><span class="op">[</span><span class="va">oo</span>,<span class="va">j</span><span class="op">]</span>, lwd<span class="op">=</span><span class="fl">2</span>, col<span class="op">=</span><span class="st">'blue'</span>, lty<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">oo</span>,<span class="va">j</span><span class="op">]</span>, <span class="va">fits</span><span class="op">[</span><span class="va">oo</span>,<span class="va">j</span><span class="op">]</span>, lwd<span class="op">=</span><span class="fl">2</span>, col<span class="op">=</span><span class="st">'magenta'</span>, lty<span class="op">=</span><span class="fl">2</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p><img src="Examples_files/figure-html/plotoutred-1.png" width="45%"><img src="Examples_files/figure-html/plotoutred-2.png" width="45%"><img src="Examples_files/figure-html/plotoutred-3.png" width="45%"></p>
<p>To investigate whether the differences between the robust and non-robust estimators are due to the outliers, we recomputed the classical fit after removing them.</p>
<p>We ran a similar leave-one-out cross-validation experiment to select the spans for each the 3 univariate smoothers.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">airclean</span> <span class="op">&lt;-</span> <span class="va">aircomplete</span><span class="op">[</span><span class="op">-</span><span class="va">in.ro</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Ozone'</span>, <span class="st">'Solar.R'</span>, <span class="st">'Wind'</span>, <span class="st">'Temp'</span><span class="op">)</span><span class="op">]</span>
<span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.3</span>, <span class="fl">.4</span>, <span class="fl">.5</span>, <span class="fl">.6</span>, <span class="fl">.7</span>, <span class="fl">.8</span>, <span class="fl">.9</span><span class="op">)</span>
<span class="va">hh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span><span class="op">(</span><span class="va">a</span>, <span class="va">a</span>, <span class="va">a</span><span class="op">)</span>
<span class="va">nh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">hh</span><span class="op">)</span>
<span class="va">jbest</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="va">cvbest</span> <span class="op">&lt;-</span> <span class="op">+</span><span class="cn">Inf</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">airclean</span><span class="op">)</span>
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">nh</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">fi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span><span class="op">)</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/gam.html">gam</a></span><span class="op">(</span><span class="va">Ozone</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">Solar.R</span>, span<span class="op">=</span><span class="va">hh</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">Wind</span>, span<span class="op">=</span><span class="va">hh</span><span class="op">[</span><span class="va">i</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>
               <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">Temp</span>, span<span class="op">=</span><span class="va">hh</span><span class="op">[</span><span class="va">i</span>,<span class="fl">3</span><span class="op">]</span><span class="op">)</span>, data<span class="op">=</span><span class="va">airclean</span>, subset<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">j</span><span class="op">)</span><span class="op">)</span>
    <span class="va">fi</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">tmp</span>, newdata<span class="op">=</span><span class="va">airclean</span><span class="op">[</span><span class="va">j</span>,<span class="op">]</span>, type<span class="op">=</span><span class="st">'response'</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="va">ss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">airclean</span><span class="op">$</span><span class="va">Ozone</span> <span class="op">-</span> <span class="va">fi</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>
  <span class="kw">if</span><span class="op">(</span><span class="va">ss</span> <span class="op">&lt;</span> <span class="va">cvbest</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">jbest</span> <span class="op">&lt;-</span> <span class="va">i</span>
    <span class="va">cvbest</span> <span class="op">&lt;-</span> <span class="va">ss</span>
  <span class="op">}</span>
<span class="op">}</span>
<span class="op">(</span><span class="va">hh</span><span class="op">[</span><span class="va">jbest</span>,<span class="op">]</span><span class="op">)</span>
<span class="co"># Var1 Var2 Var3</span>
<span class="co"># 0.7  0.8  0.3</span></code></pre></div>
<p>We use the optimal bandwidths to compute non-robust fit.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">airclean</span> <span class="op">&lt;-</span> <span class="va">aircomplete</span><span class="op">[</span><span class="op">-</span><span class="va">in.ro</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Ozone'</span>, <span class="st">'Solar.R'</span>, <span class="st">'Wind'</span>, <span class="st">'Temp'</span><span class="op">)</span><span class="op">]</span>
<span class="va">fit.gam2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/gam.html">gam</a></span><span class="op">(</span><span class="va">Ozone</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">Solar.R</span>, span<span class="op">=</span><span class="fl">.7</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">Wind</span>, span<span class="op">=</span><span class="fl">.8</span><span class="op">)</span><span class="op">+</span>
                  <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">Temp</span>, span<span class="op">=</span><span class="fl">.3</span><span class="op">)</span>, data<span class="op">=</span><span class="va">airclean</span><span class="op">)</span> </code></pre></div>
<p>The following plot shows the estimated curves obtained with the classical estimator using the clean data together with the robust ones (computed on the whole data set). Outliers are highlighted in red.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fits2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit.gam2</span>, type<span class="op">=</span><span class="st">'terms'</span><span class="op">)</span>
<span class="va">dd2</span> <span class="op">&lt;-</span> <span class="va">aircomplete</span><span class="op">[</span><span class="op">-</span><span class="va">in.ro</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Solar.R'</span>, <span class="st">'Wind'</span>, <span class="st">'Temp'</span><span class="op">)</span><span class="op">]</span>
<span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">re</span> <span class="op">&lt;-</span> <span class="va">fit.full</span><span class="op">$</span><span class="va">yp</span> <span class="op">-</span> <span class="va">fit.full</span><span class="op">$</span><span class="va">alpha</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">fit.full</span><span class="op">$</span><span class="va">g.matrix</span><span class="op">[</span>,<span class="op">-</span><span class="va">j</span><span class="op">]</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span><span class="op">(</span><span class="va">re</span> <span class="op">~</span> <span class="va">x</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span>, type<span class="op">=</span><span class="st">'p'</span>, pch<span class="op">=</span><span class="fl">20</span>, col<span class="op">=</span><span class="st">'gray45'</span>, xlab<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>, ylab<span class="op">=</span><span class="st">''</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="va">re</span><span class="op">[</span><span class="va">in.ro</span><span class="op">]</span> <span class="op">~</span> <span class="va">x</span><span class="op">[</span><span class="va">in.ro</span>,<span class="va">j</span><span class="op">]</span>, pch<span class="op">=</span><span class="fl">20</span>, col<span class="op">=</span><span class="st">'red'</span><span class="op">)</span>
  <span class="va">oo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">dd2</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">dd2</span><span class="op">[</span><span class="va">oo</span>,<span class="va">j</span><span class="op">]</span>, <span class="va">fits2</span><span class="op">[</span><span class="va">oo</span>,<span class="va">j</span><span class="op">]</span>, lwd<span class="op">=</span><span class="fl">2</span>, col<span class="op">=</span><span class="st">'magenta'</span>, lty<span class="op">=</span><span class="fl">2</span><span class="op">)</span>
  <span class="va">oo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">oo</span>,<span class="va">j</span><span class="op">]</span>, <span class="va">fit.full</span><span class="op">$</span><span class="va">g.matrix</span><span class="op">[</span><span class="va">oo</span>,<span class="va">j</span><span class="op">]</span>, lwd<span class="op">=</span><span class="fl">2</span>, col<span class="op">=</span><span class="st">'blue'</span>, lty<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p><img src="Examples_files/figure-html/finalplot-1.png" width="45%"><img src="Examples_files/figure-html/finalplot-2.png" width="45%"><img src="Examples_files/figure-html/finalplot-3.png" width="45%"></p>
<p>Note that both fits are now very close. An intuitive interpretation is that the robust fit has automatically down-weighted potential outliers and produced estimates very similar to the classical ones applied to the clean observations.</p>
<div id="prediction-comparison" class="section level3">
<h3 class="hasAnchor">
<a href="#prediction-comparison" class="anchor"></a>Prediction comparison</h3>
<p>Finally, we compare the prediction accuracy obtained with each of the fits. Because we are not interested in predicting well any possible outliers in the data, we evaluate the quality of the predictions using a 5%-trimmed mean squared prediction error (effectively measuring the prediction accuracy on 95% of the data). We use this alpha-trimmed mean squared function:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tms</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">a</span>, <span class="va">alpha</span><span class="op">=</span><span class="fl">.1</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># alpha is the proportion to trim</span>
  <span class="va">a2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="va">a</span><span class="op">^</span><span class="fl">2</span>, na.last<span class="op">=</span><span class="cn">NA</span><span class="op">)</span>
  <span class="va">n0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">alpha</span><span class="op">)</span> <span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">a2</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">n0</span><span class="op">]</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>We use 100 runs of 5-fold CV to compare the 5%-trimmed mean squared prediction error of the robust fit and the classical one. Note that the bandwidths are kept fixed at their optimal value estimated above.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dd</span> <span class="op">&lt;-</span> <span class="va">airquality</span>
<span class="va">dd</span> <span class="op">&lt;-</span> <span class="va">dd</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">dd</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'Ozone'</span>, <span class="st">'Solar.R'</span>, <span class="st">'Wind'</span>, <span class="st">'Temp'</span><span class="op">)</span><span class="op">]</span>
<span class="co"># 100 runs of K-fold CV</span>
<span class="va">M</span> <span class="op">&lt;-</span> <span class="fl">100</span>
<span class="co"># 5-fold</span>
<span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">5</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">dd</span><span class="op">)</span>
<span class="co"># store (trimmed) TMSPE for robust and gam, and also</span>
<span class="va">tmspe.ro</span> <span class="op">&lt;-</span> <span class="va">tmspe.gam</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">'numeric'</span>, <span class="va">M</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="va">ii</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span><span class="op">%%</span><span class="va">K</span> <span class="op">+</span> <span class="fl">1</span>
<span class="kw">for</span><span class="op">(</span><span class="va">runs</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">M</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">tmpro</span> <span class="op">&lt;-</span> <span class="va">tmpgam</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">'numeric'</span>, <span class="va">n</span><span class="op">)</span>
  <span class="va">ii</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">ii</span><span class="op">)</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">K</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">fit.full</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/backf.rob.html">backf.rob</a></span><span class="op">(</span><span class="va">Ozone</span> <span class="op">~</span> <span class="va">Solar.R</span> <span class="op">+</span> <span class="va">Wind</span> <span class="op">+</span> <span class="va">Temp</span>, 
                           point<span class="op">=</span><span class="va">dd</span><span class="op">[</span><span class="va">ii</span><span class="op">==</span><span class="va">j</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span>, windows <span class="op">=</span> <span class="va">bandw</span>, 
                           epsilon <span class="op">=</span> <span class="fl">1e-6</span>, degree <span class="op">=</span> <span class="fl">1</span>, type <span class="op">=</span> <span class="st">'Tukey'</span>, 
                           subset <span class="op">=</span> <span class="op">(</span><span class="va">ii</span><span class="op">!=</span><span class="va">j</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">dd</span><span class="op">)</span>
    <span class="va">tmpro</span><span class="op">[</span> <span class="va">ii</span> <span class="op">==</span> <span class="va">j</span> <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">fit.full</span><span class="op">$</span><span class="va">prediction</span><span class="op">)</span> <span class="op">+</span> <span class="va">fit.full</span><span class="op">$</span><span class="va">alpha</span>
    <span class="va">fit.gam</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/gam.html">gam</a></span><span class="op">(</span><span class="va">Ozone</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">Solar.R</span>, span<span class="op">=</span><span class="fl">.7</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">Wind</span>, span<span class="op">=</span><span class="fl">.7</span><span class="op">)</span><span class="op">+</span>
                     <span class="fu"><a href="https://rdrr.io/pkg/gam/man/lo.html">lo</a></span><span class="op">(</span><span class="va">Temp</span>, span<span class="op">=</span><span class="fl">.5</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">dd</span><span class="op">[</span><span class="va">ii</span><span class="op">!=</span><span class="va">j</span>, <span class="op">]</span><span class="op">)</span>
    <span class="va">tmpgam</span><span class="op">[</span> <span class="va">ii</span> <span class="op">==</span> <span class="va">j</span> <span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit.gam</span>, newdata<span class="op">=</span><span class="va">dd</span><span class="op">[</span><span class="va">ii</span><span class="op">==</span><span class="va">j</span>, <span class="op">]</span>, type<span class="op">=</span><span class="st">'response'</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="va">tmspe.ro</span><span class="op">[</span><span class="va">runs</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">tms</span><span class="op">(</span> <span class="va">dd</span><span class="op">$</span><span class="va">Ozone</span> <span class="op">-</span> <span class="va">tmpro</span>, alpha<span class="op">=</span><span class="fl">0.05</span><span class="op">)</span>
  <span class="va">tmspe.gam</span><span class="op">[</span><span class="va">runs</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">tms</span><span class="op">(</span> <span class="va">dd</span><span class="op">$</span><span class="va">Ozone</span> <span class="op">-</span> <span class="va">tmpgam</span>, alpha<span class="op">=</span><span class="fl">0.05</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>These are the boxplots. We see that the robust fit consistently fits the vast majority (95%) of the data better than the classical one.</p>
<div class="figure">
<img src="pred3.png" style="width:50.0%" alt=""><p class="caption">Boxplots of the prediction errors </p>
</div>
<!-- As a sanity check, we compare the prediction accuracy of the robust and non-robust fits using only the "clean" data set. We re-compute the optimal bandwidths for the robust fit using leave-one-out cross validation as above, and as above, note that these bandwidths are kept fixed.  We use 100 runs of 5-fold cross-validation, and compute both the trimmed and the regular mean squared prediction errors of each fit. -->
<!-- ```{r pred.clean, cache=TRUE, warning=FALSE, eval=FALSE} -->
<!-- aq <- airquality -->
<!-- aq2 <- aq[complete.cases(aq), c('Ozone', 'Solar.R', 'Wind', 'Temp')] -->
<!-- airclean <- aq2[ -in.ro, ] -->
<!-- bandw <- c(138.2699, 10.46753, 4.828436) -->
<!-- M <- 100  -->
<!-- K <- 5 -->
<!-- n <- nrow(airclean) -->
<!-- mspe.ro <- mspe.gam <- tmspe.ro <- tmspe.gam <- vector('numeric', M) -->
<!-- set.seed(17) -->
<!-- ii <- (1:n)%%K + 1 -->
<!-- for(runs in 1:M) { -->
<!--   tmpro <- tmpgam <- vector('numeric', n) -->
<!--   ii <- sample(ii) -->
<!--   for(j in 1:K) { -->
<!--     fit.full <- try( backf.rob(Ozone ~ Solar.R + Wind + Temp,  -->
<!--                           point=airclean[ii==j, -1], windows = bandw,  -->
<!--                           epsilon = 1e-6, degree = 1, type = 'Tukey',  -->
<!--                           subset = (ii!=j), data = airclean) ) -->
<!--     if (class(fit.full)[1] != "try-error") { -->
<!--       tmpro[ ii == j ] <- rowSums(fit.full$prediction) + fit.full$alpha -->
<!--     } -->
<!--     fit.gam <- gam(Ozone ~ lo(Solar.R, span=.7) + lo(Wind, span=.8)+ -->
<!--                      lo(Temp, span=.3), data = airclean, subset = (ii!=j) ) -->
<!--     tmpgam[ ii == j ] <- predict(fit.gam, newdata=airclean[ii==j, ],  -->
<!--                                  type='response') -->
<!--   } -->
<!--   tmspe.ro[runs] <- tms( airclean$Ozone - tmpro, alpha=0.05) -->
<!--   mspe.ro[runs] <- mean( ( airclean$Ozone - tmpro)^2, na.rm=TRUE) -->
<!--   tmspe.gam[runs] <- tms( airclean$Ozone - tmpgam, alpha=0.05) -->
<!--   mspe.gam[runs] <- mean( ( airclean$Ozone - tmpgam)^2, na.rm=TRUE) -->
<!-- } -->
<!-- ``` -->
<!-- The boxplots of the trimmed and regular mean squared prediction  -->
<!-- errors over the 100 cross-validation runs are below. We see that -->
<!-- for the majority of the runs both estimators provide very similar -->
<!-- prediction errors. Note that we naturally expect a robust method to  -->
<!-- perform slightly worse than the classical one when no model -->
<!-- deviations occur. The boxplots below show that for this  -->
<!-- robust backfitting estimator, this loss in prediction accuracy is -->
<!-- in fact very small.  -->
<!-- ![Trimmed MSPE On \lq\lq clean\rq\rq data \label{fig:tmspeclean}](tmspeclean.png){ width=50% } -->
<!-- ![Non-Trimmed MSPE On \lq\lq clean\rq\rq data \label{fig:nontmspeclean}](nontmspeclean.png){ width=50% } -->
</div>
</div>
<div id="bibliography" class="section level2">
<h2 class="hasAnchor">
<a href="#bibliography" class="anchor"></a>Bibliography</h2>
<p>Boente G, Martinez A, and Salibian-Barrera M. (2017) Robust estimators for additive models using backfitting. <em>Journal of Nonparametric Statistics</em>, <strong>29</strong>, 744-767. <a href="https://doi.org/10.1080/10485252.2017.1369077">DOI: 10.1080/10485252.2017.1369077</a></p>
<p>Chambers, J. M., Cleveland W. S., Kleiner B. and Tukey A. (1983). <em>Graphical Methods for Data Analysis</em>. 2nd edition. Chapman &amp; Hall. <a href="https://doi.org/10.1201/9781351072304">DOI: 10.1201/9781351072304</a></p>
<p>Härdle, W., Müller, M., Sperlich, S. and Werwatz, A. (2004). <em>Nonparametric and Semiparametric Models</em>. Springer. <a href="https://doi.org/10.1007/978-3-642-17146-8">DOI: 10.1007/978-3-642-17146-8</a></p>
<p>Harrinson, D. and Rubinfeld, D. L. (1978). Hedonic prices and the demand for clean air. <em>J. Environ. Economics and Management</em>, <strong>5</strong>, 81-102. <a href="https://doi.org/10.1016/0095-0696(78)90006-2">DOI: 10.1016/0095-0696(78)90006-2</a></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Matias Salibian-Barrera, Alejandra Martinez.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
